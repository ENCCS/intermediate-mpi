<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generalized forms of gather &mdash; Intermediate MPI</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_lesson.css" type="text/css" />
      <link rel="stylesheet" href="../_static/overrides.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script data-domain="enccs.github.io/intermediate-mpi" defer="defer" src="https://plausible.io/js/script.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Non-blocking point-to-point" href="../non-blocking-communication-pt1/" />
    <link rel="prev" title="Scatter and gather" href="../collective-communication-pt2/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            Intermediate MPI
              <img src="../_static/ENCCS.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Setting up your system</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../communicators-groups/">Communicators and groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../derived-datatypes-pt1/">Derived datatypes: pack and unpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../derived-datatypes-pt2/">Derived datatypes: <code class="docutils literal notranslate"><span class="pre">MPI_Datatype</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../collective-communication-pt1/">Simple collective communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collective-communication-pt2/">Scatter and gather</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Generalized forms of gather</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#all-gather">All-gather</a></li>
<li class="toctree-l2"><a class="reference internal" href="#all-to-all">All-to-all</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exercise-all-gather-and-all-to-all">Exercise: all-gather and all-to-all</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scatterv">Scatterv</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gatherv">Gatherv</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exercise-scatterv-and-gatherv">Exercise: scatterv and gatherv</a></li>
<li class="toctree-l2"><a class="reference internal" href="#final-thoughts">Final thoughts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../non-blocking-communication-pt1/">Non-blocking point-to-point</a></li>
<li class="toctree-l1"><a class="reference internal" href="../non-blocking-communication-pt2/">Non-blocking collective communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../one-sided-concepts/">One-sided communication: concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../one-sided-routines/">One-sided communication: functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../one-sided-sync/">One-sided communication: synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mpi-and-threads-pt1/">Introducing MPI and threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mpi-and-threads-pt2/">MPI and threads in practice</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zbibliography/">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">Intermediate MPI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Generalized forms of gather</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ENCCS/intermediate-mpi/blob/master/content/collective-communication-pt3.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="generalized-forms-of-gather">
<h1>Generalized forms of gather<a class="headerlink" href="#generalized-forms-of-gather" title="Permalink to this heading"></a></h1>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>How can I do more complex rearrangements of data?</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Know that gather can be generalized</p></li>
<li><p>Know the difference between generalized forms of gather</p></li>
</ul>
</div>
<section id="all-gather">
<h2>All-gather<a class="headerlink" href="#all-gather" title="Permalink to this heading"></a></h2>
<p>An <code class="docutils literal notranslate"><span class="pre">MPI_Allgather</span></code> call gather the same data from all ranks and
provides it to all ranks. It is logically identical to <code class="docutils literal notranslate"><span class="pre">MPI_Gather</span></code>
to a root followed by an <code class="docutils literal notranslate"><span class="pre">MPI_Bcast</span></code> from that root, but is
implemented more efficiently.</p>
<figure class="align-center" id="id1">
<img alt="../_images/MPI_Allgather.svg" src="../_images/MPI_Allgather.svg" /><figcaption>
<p><span class="caption-text">After the call, all ranks have one value from each other rank in
the communicator, ordered by rank number.</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p><code class="docutils literal notranslate"><span class="pre">MPI_Allgather</span></code> is <cite>blocking</cite> and introduces <cite>collective
synchronization</cite> into the program. Note that there is no root
for this operation.</p>
<p>This can be useful to allow all ranks to collect values from all other
ranks in the communicator. For example, all ranks might compute some
values, and then all ranks gather that content to use it in a
subsequent stage.</p>
<div class="admonition-term-mpi-allgather signature toggle-shown dropdown admonition" id="signature-0">
<p class="admonition-title"><a class="reference internal" href="../quick-reference/index.html#term-MPI_Allgather"><span class="xref std std-term"><code class="docutils literal notranslate">MPI_Allgather</code></span></a></p>
<p>Gathers data from all ranks and provides the same data to all ranks.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">MPI_Allgather</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sendbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span>
<span class="w">                  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">recvbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">recvcount</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span>
<span class="w">                  </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition-parameters parameters dropdown admonition" id="parameters-0">
<p class="admonition-title">Parameters</p>
<p>All ranks receive the values send from each process.</p>
<p><code class="docutils literal notranslate"><span class="pre">sendbuf</span></code>, <code class="docutils literal notranslate"><span class="pre">sendcount</span></code> and <code class="docutils literal notranslate"><span class="pre">sendtype</span></code> describe the buffer on
<strong>each</strong> process from which the data is sent. Only a buffer large
enough to contain the data sent by that process is needed.</p>
<p><code class="docutils literal notranslate"><span class="pre">recvbuf</span></code>, <code class="docutils literal notranslate"><span class="pre">recvcount</span></code> and <code class="docutils literal notranslate"><span class="pre">recvtype</span></code> describe the buffer on
<strong>each</strong> process to which the data is sent. A buffer large
enough to receive all the data for that process is needed.</p>
<p>All ranks in the communicator must participate with valid receive
buffers and consistent counts and types.</p>
</div>
</section>
<section id="all-to-all">
<h2>All-to-all<a class="headerlink" href="#all-to-all" title="Permalink to this heading"></a></h2>
<p>An <code class="docutils literal notranslate"><span class="pre">MPI_Alltoall</span></code> call gathers data from all ranks and provides
distinct data to all ranks. It is logically identical to making one
call to <code class="docutils literal notranslate"><span class="pre">MPI_Gather</span></code> for each possible root rank, but is implemented
more efficiently.</p>
<figure class="align-center" id="id2">
<img alt="../_images/MPI_Alltoall.svg" src="../_images/MPI_Alltoall.svg" /><figcaption>
<p><span class="caption-text">After the call, all ranks have one value from each other rank in
the communicator, ordered by rank number.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p><code class="docutils literal notranslate"><span class="pre">MPI_Alltoall</span></code> is <cite>blocking</cite> and introduces <cite>collective
synchronization</cite> into the program. Note that there is no root
for this operation.</p>
<p>This can be useful to allow all ranks to collect values from all other
ranks in the communicator. For example, a 3D Fast Fourier Transform
often uses an all-to-all operation to redistribute the working data
set for each process to a new dimension.</p>
<div class="admonition-term-mpi-alltoall signature toggle-shown dropdown admonition" id="signature-1">
<p class="admonition-title"><a class="reference internal" href="../quick-reference/index.html#term-MPI_Alltoall"><span class="xref std std-term"><code class="docutils literal notranslate">MPI_Alltoall</code></span></a></p>
<p>Gathers data from all ranks and provides distinct data to all ranks.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">MPI_Alltoall</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sendbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span>
<span class="w">                 </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">recvbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">recvcount</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span>
<span class="w">                 </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition-parameters parameters dropdown admonition" id="parameters-1">
<p class="admonition-title">Parameters</p>
<p>All ranks receive a subset of the values sent from each process.</p>
<p><code class="docutils literal notranslate"><span class="pre">sendbuf</span></code>, <code class="docutils literal notranslate"><span class="pre">sendcount</span></code> and <code class="docutils literal notranslate"><span class="pre">sendtype</span></code> describe the buffer on
<strong>each</strong> process from which the data is sent. Only a buffer large
enough to contain the data sent by that process is needed.</p>
<p><code class="docutils literal notranslate"><span class="pre">recvbuf</span></code>, <code class="docutils literal notranslate"><span class="pre">recvcount</span></code> and <code class="docutils literal notranslate"><span class="pre">recvtype</span></code> describe the buffer on
<strong>each</strong> process to which the data is sent. A buffer large
enough to receive all the data for that process is needed.</p>
<p>All ranks in the communicator must participate with valid receive
buffers and consistent counts and types.</p>
</div>
</section>
<section id="exercise-all-gather-and-all-to-all">
<h2>Exercise: all-gather and all-to-all<a class="headerlink" href="#exercise-all-gather-and-all-to-all" title="Permalink to this heading"></a></h2>
<div class="admonition-use-all-gather exercise important admonition" id="exercise-0">
<p class="admonition-title">Use all-gather</p>
<p>You can find a scaffold for the code in the
<code class="docutils literal notranslate"><span class="pre">content/code/day-2/01_allgather</span></code> folder.  A working solution is in the
<code class="docutils literal notranslate"><span class="pre">solution</span></code> subfolder. Try to compile with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpicc</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c11</span> <span class="n">collective</span><span class="o">-</span><span class="n">communication</span><span class="o">-</span><span class="n">allgather</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">collective</span><span class="o">-</span><span class="n">communication</span><span class="o">-</span><span class="n">allgather</span>
</pre></div>
</div>
<ol class="arabic">
<li><p>When you have the code compiling, try to run with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpiexec</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> <span class="o">./</span><span class="n">collective</span><span class="o">-</span><span class="n">communication</span><span class="o">-</span><span class="n">allgather</span>
</pre></div>
</div>
</li>
<li><p>Use clues from the compiler and the comments in the code to
change the code so it compiles and runs. Try to get all ranks to
report success :-)</p></li>
</ol>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<ul>
<li><p>One correct call is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MPI_Allgather</span><span class="p">(</span><span class="n">values_to_all_gather</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span>
              <span class="n">result_values</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span>
              <span class="n">comm</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>What happened if you mistakenly used 4 or 12 for the counts? Why?</p></li>
</ul>
</div>
<div class="admonition-use-all-to-all exercise important admonition" id="exercise-1">
<p class="admonition-title">Use all-to-all</p>
<p>You can find a scaffold for the code in the
<code class="docutils literal notranslate"><span class="pre">content/code/day-2/02_alltoall</span></code> folder.  A working solution is in the
<code class="docutils literal notranslate"><span class="pre">solution</span></code> subfolder. Try to compile with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpicc</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c11</span> <span class="n">collective</span><span class="o">-</span><span class="n">communication</span><span class="o">-</span><span class="n">alltoall</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">collective</span><span class="o">-</span><span class="n">communication</span><span class="o">-</span><span class="n">alltoall</span>
</pre></div>
</div>
<ol class="arabic" start="2">
<li><p>When you have the code compiling, try to run with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpiexec</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> <span class="o">./</span><span class="n">collective</span><span class="o">-</span><span class="n">communication</span><span class="o">-</span><span class="n">alltoall</span>
</pre></div>
</div>
</li>
<li><p>Use clues from the compiler and the comments in the code to
change the code so it compiles and runs. Try to get all ranks to
report success :-)</p></li>
</ol>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-1">
<p class="admonition-title">Solution</p>
<ul>
<li><p>One correct call is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MPI_Alltoall</span><span class="p">(</span><span class="n">values_to_all_to_all</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span>
             <span class="o">&amp;</span><span class="n">result_values</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span>
             <span class="n">comm</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>What happened if you mistakenly used 4 or 12 for the counts? Why?</p></li>
</ul>
</div>
</section>
<section id="scatterv">
<h2>Scatterv<a class="headerlink" href="#scatterv" title="Permalink to this heading"></a></h2>
<p>An <code class="docutils literal notranslate"><span class="pre">MPI_Scatterv</span></code> call scatters a buffer in parts to all ranks.
It uses <code class="docutils literal notranslate"><span class="pre">sendcounts</span></code> and <code class="docutils literal notranslate"><span class="pre">displs</span></code> to determine the number of
elements to be sent to each rank.</p>
<p><code class="docutils literal notranslate"><span class="pre">MPI_Scatterv</span></code> is <cite>blocking</cite> and introduces <cite>collective
synchronization</cite> into the program.</p>
<p>This can be useful to when we want to distribute different amount of
data to different processes.</p>
<div class="admonition-mpi-scatterv signature toggle-shown dropdown admonition" id="signature-2">
<p class="admonition-title">MPI_Scatterv</p>
<p>Scatters data in parts to all ranks.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">MPI_Scatterv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sendbuf</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">sendcounts</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">displs</span><span class="p">,</span>
<span class="w">                 </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">recvbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">recvcount</span><span class="p">,</span>
<span class="w">                 </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span>
<span class="w">                 </span><span class="kt">int</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition-parameters parameters dropdown admonition" id="parameters-2">
<p class="admonition-title">Parameters</p>
<p><code class="docutils literal notranslate"><span class="pre">sendbuf</span></code>, <code class="docutils literal notranslate"><span class="pre">sendcounts</span></code>, <code class="docutils literal notranslate"><span class="pre">displs</span></code> and <code class="docutils literal notranslate"><span class="pre">sendtype</span></code> describe the
buffer on the root process from which the data is sent. <code class="docutils literal notranslate"><span class="pre">sendcounts</span></code>
is an integer array that holds the number of elements to be sent to
each process. <code class="docutils literal notranslate"><span class="pre">displs</span></code> is an integer array that holds the
displacement of the elements to be sent to each process.</p>
<p><code class="docutils literal notranslate"><span class="pre">recvbuf</span></code>, <code class="docutils literal notranslate"><span class="pre">recvcount</span></code> and <code class="docutils literal notranslate"><span class="pre">recvtype</span></code> describe the buffer on
each process to which the data is sent. A buffer large
enough to receive the data for that process is needed.</p>
<p>All ranks in the communicator must participate with valid receive
buffers and consistent counts and types.</p>
</div>
</section>
<section id="gatherv">
<h2>Gatherv<a class="headerlink" href="#gatherv" title="Permalink to this heading"></a></h2>
<p>An <code class="docutils literal notranslate"><span class="pre">MPI_Gatherv</span></code> call gathers info with variable size from all
ranks. It uses <code class="docutils literal notranslate"><span class="pre">recvcounts</span></code> and <code class="docutils literal notranslate"><span class="pre">displs</span></code> to determine the number of
elements to be collected from each rank.</p>
<p><code class="docutils literal notranslate"><span class="pre">MPI_Gatherv</span></code> is <cite>blocking</cite> and introduces <cite>collective
synchronization</cite> into the program.</p>
<p>This can be useful to when we want to collect different amount of
data from different processes.</p>
<div class="admonition-mpi-gatherv signature toggle-shown dropdown admonition" id="signature-3">
<p class="admonition-title">MPI_Gatherv</p>
<p>Gathers data with variable size from all ranks.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">MPI_Gatherv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sendbuf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sendcount</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">sendtype</span><span class="p">,</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">recvbuf</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">recvcounts</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">displs</span><span class="p">,</span>
<span class="w">                </span><span class="n">MPI_Datatype</span><span class="w"> </span><span class="n">recvtype</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition-parameters parameters dropdown admonition" id="parameters-3">
<p class="admonition-title">Parameters</p>
<p><code class="docutils literal notranslate"><span class="pre">sendbuf</span></code>, <code class="docutils literal notranslate"><span class="pre">sendcount</span></code> and <code class="docutils literal notranslate"><span class="pre">sendtype</span></code> describe the buffer on
each process from which the data is collected.</p>
<p><code class="docutils literal notranslate"><span class="pre">recvbuf</span></code>, <code class="docutils literal notranslate"><span class="pre">recvcounts</span></code>, <code class="docutils literal notranslate"><span class="pre">displs</span></code> and <code class="docutils literal notranslate"><span class="pre">recvtype</span></code> describe the
buffer on the root process on which the data is collected. <code class="docutils literal notranslate"><span class="pre">recvcounts</span></code>
is an integer array that holds the number of elements to be collected
from each process. <code class="docutils literal notranslate"><span class="pre">displs</span></code> is an integer array that holds the
displacement of the elements to be collected from each process.</p>
<p>All ranks in the communicator must participate. The root process
must have a valid receive buffer with consistent size and type.</p>
</div>
</section>
<section id="exercise-scatterv-and-gatherv">
<h2>Exercise: scatterv and gatherv<a class="headerlink" href="#exercise-scatterv-and-gatherv" title="Permalink to this heading"></a></h2>
<div class="admonition-use-scatterv-and-gatherv-to-compute-matrix-vector-multiplication exercise important admonition" id="exercise-2">
<p class="admonition-title">Use scatterv and gatherv to compute matrix vector multiplication</p>
<p>In this exercise we compute matrix vector multiplication using <code class="docutils literal notranslate"><span class="pre">MPI_Scatterv</span></code>
and <code class="docutils literal notranslate"><span class="pre">MPI_Gatherv</span></code>. One would need to scatter the row vectors of the matrix
to the individual processes, broadcast the vector, and then calculate the
local contribution to the matrix vector product. After that the local
contributions are collected to the root process to form the final result.</p>
<figure class="align-center" id="id3">
<img alt="../_images/mat-vec.png" src="../_images/mat-vec.png" />
<figcaption>
<p><span class="caption-text">Matrix vector multiplication in parallel</span><a class="headerlink" href="#id3" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>You can find a scaffold for the code in the
<code class="docutils literal notranslate"><span class="pre">content/code/day-2/03_scatterv-and-gatherv</span></code> folder.
A working solution is in the
<code class="docutils literal notranslate"><span class="pre">solution</span></code> subfolder. Try to compile with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpicc</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c11</span> <span class="n">scatterv</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">gatherv</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">scatterv</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">gatherv</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>When you have the code compiling, try to run with different number of processes.</p></li>
<li><p>Try to get rank 0 to report success :-)</p></li>
</ol>
</div>
</section>
<section id="final-thoughts">
<h2>Final thoughts<a class="headerlink" href="#final-thoughts" title="Permalink to this heading"></a></h2>
<p>There are further generalizations available in MPI (e.g.
combined scatter-gather). Check the existing
options before rolling your own or giving up!</p>
</section>
<section id="see-also">
<h2>See also<a class="headerlink" href="#see-also" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.mcs.anl.gov/~thakur/sc17-mpi-tutorial/slides.pdf">https://www.mcs.anl.gov/~thakur/sc17-mpi-tutorial/slides.pdf</a></p></li>
<li><p><a class="reference external" href="https://rookiehpc.github.io/mpi/docs/mpi_allgather/index.html">https://rookiehpc.github.io/mpi/docs/mpi_allgather/index.html</a></p></li>
<li><p><a class="reference external" href="https://rookiehpc.github.io/mpi/docs/mpi_alltoall/index.html">https://rookiehpc.github.io/mpi/docs/mpi_alltoall/index.html</a></p></li>
</ul>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>More complex distribution patterns are also optimized in MPI</p></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../collective-communication-pt2/" class="btn btn-neutral float-left" title="Scatter and gather" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../non-blocking-communication-pt1/" class="btn btn-neutral float-right" title="Non-blocking point-to-point" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, EuroCC National Competence Centre Sweden.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>